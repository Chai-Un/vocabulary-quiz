<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Vocabulary Quiz</title>
		<link
			href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
			rel="stylesheet"
		/>
		<style>
			.option-card {
				cursor: pointer;
				transition: background-color 0.3s;
				display: flex;
				justify-content: flex-start;
				padding: 8px;
				font-size: 13px;
				min-width: 100%;
			}
			.option-card.selected {
				background-color: rgb(182, 212, 168);
			}
			#submitBtn {
				display: none;
			}
			.card-body {
				padding: 10px;
			}
			.modal-body {
				max-height: 80vh;
				overflow-y: auto;
			}

			/* Enhanced Fireworks Animation CSS */
			.pyro {
				position: fixed;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				z-index: 1060;
				pointer-events: none;
				display: none;
			}

			/* Add multiple particle layers */
			.pyro > .before,
			.pyro > .after {
				position: absolute;
				width: 6px;
				height: 6px;
				border-radius: 50%;
				box-shadow: 0 0 #fff;
				animation: 1s bang ease-out infinite backwards,
					1s gravity ease-in infinite backwards,
					5s position linear infinite backwards;
				opacity: 0.7;
			}

			/* Add more delayed particles for depth */
			.pyro > .after {
				animation-delay: 1.25s, 1.25s, 1.25s;
				animation-duration: 1.25s, 1.25s, 6.25s;
			}

			/* Extra particle layers */
			.pyro::before {
				content: '';
				position: absolute;
				width: 5px;
				height: 5px;
				border-radius: 50%;
				box-shadow: 0 0 #fff;
				animation: 1.1s bang ease-out infinite backwards,
					1.1s gravity ease-in infinite backwards,
					5.5s position2 linear infinite backwards;
				opacity: 0.8;
			}

			.pyro::after {
				content: '';
				position: absolute;
				width: 4px;
				height: 4px;
				border-radius: 50%;
				box-shadow: 0 0 #fff;
				animation: 0.9s bang ease-out infinite backwards,
					0.9s gravity ease-in infinite backwards,
					4.5s position3 linear infinite backwards;
				opacity: 0.6;
			}

			/* Enhanced explosion patterns with more colors */
			@keyframes bang {
				to {
					box-shadow: -70px -33px #ff0000, 56px -87px #0400ff,
						7px -62px #00ff15, 85px 46px #ff00e6,
						141px -74px #00ffb3, -149px -28px #ff6700,
						149px -32px #0040ff, -37px 69px #00d5ff,
						-20px -92px #9d00ff, 148px -48px #004dff,
						141px 48px #006fff, 130px -93px #b700ff,
						-88px 35px #1eff00, -24px -59px #a2ff00,
						71px -52px #00ff9d, -128px -79px #00ff37,
						-33px 59px #ff0099, 129px 69px #ff0037,
						-81px -39px #00ffea, 21px -28px #ff8400,
						101px 68px #0059ff, -88px -38px #0004ff,
						56px -50px #ffa600, 52px -19px #0095ff,
						70px 21px #00ff33, 128px 80px #ff8c00,
						139px 17px #ff9d00, 70px 43px #3cff00,
						-114px -34px #a6ff00, 117px 60px #0095ff,
						66px 15px #002fff, 35px -35px #73ff00,
						-2px -44px #0088ff, 104px 14px #00ff95,
						-65px -10px #ff00dd, 123px 70px #00ff88,
						-92px 72px #0037ff, 139px 28px #0dff00,
						135px -29px #0070ff, -120px -55px #ffcc00,
						86px -127px #ff00aa, 27px -82px #ffff00,
						105px 66px #00ffcc, 161px -94px #ff5500,
						-169px -48px #aa00ff, 169px -52px #ff0088,
						-57px 89px #22ffff, -40px -112px #ff77ff,
						168px -68px #2244ff, 161px 68px #00aaff,
						150px -113px #7700ff;
				}
			}

			/* Enhanced gravity effect */
			@keyframes gravity {
				to {
					transform: translateY(250px) scale(0.8);
					opacity: 0;
				}
			}

			/* More varied position patterns */
			@keyframes position {
				0%,
				19.9% {
					margin-top: 5%;
					margin-left: 40%;
				}
				20%,
				39.9% {
					margin-top: 40%;
					margin-left: 30%;
				}
				40%,
				59.9% {
					margin-top: 20%;
					margin-left: 70%;
				}
				60%,
				79.9% {
					margin-top: 30%;
					margin-left: 20%;
				}
				80%,
				99.9% {
					margin-top: 25%;
					margin-left: 65%;
				}
			}

			@keyframes position2 {
				0%,
				19.9% {
					margin-top: 10%;
					margin-left: 30%;
				}
				20%,
				39.9% {
					margin-top: 35%;
					margin-left: 25%;
				}
				40%,
				59.9% {
					margin-top: 25%;
					margin-left: 65%;
				}
				60%,
				79.9% {
					margin-top: 35%;
					margin-left: 15%;
				}
				80%,
				99.9% {
					margin-top: 30%;
					margin-left: 70%;
				}
			}

			@keyframes position3 {
				0%,
				19.9% {
					margin-top: 15%;
					margin-left: 35%;
				}
				20%,
				39.9% {
					margin-top: 45%;
					margin-left: 35%;
				}
				40%,
				59.9% {
					margin-top: 15%;
					margin-left: 75%;
				}
				60%,
				79.9% {
					margin-top: 25%;
					margin-left: 25%;
				}
				80%,
				99.9% {
					margin-top: 35%;
					margin-left: 60%;
				}
			}

			.congratulations {
				color: #28a745;
				font-size: 24px;
				font-weight: bold;
				text-align: center;
				margin-bottom: 20px;
			}
		</style>
	</head>
	<body class="bg-light p-5">
		<div class="container">
			<h1 class="text-center mb-4">Vocabulary Quiz</h1>

			<label for="questionCount" class="form-label"
				>Number of questions:</label
			>
			<input
				type="number"
				id="questionCount"
				class="form-control mb-4"
				value="10"
				min="1"
				max="50"
			/>

			<button class="btn btn-success mb-4" onclick="generateQuiz()">
				Start Quiz
			</button>

			<div id="quiz" class="mb-4"></div>
			<button
				id="submitBtn"
				class="btn btn-primary"
				onclick="submitQuiz()"
			>
				Submit
			</button>
		</div>

		<div
			id="resultPopup"
			class="modal fade"
			tabindex="-1"
			aria-hidden="true"
		>
			<div class="modal-dialog modal-lg">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title">Quiz Result</h5>
						<button
							type="button"
							class="btn-close"
							onclick="closePopup()"
						></button>
					</div>
					<div class="modal-body">
						<p id="score"></p>
						<div id="congratsMessage"></div>
						<div id="incorrectList"></div>
					</div>
					<div class="modal-footer">
						<button
							type="button"
							class="btn btn-success"
							onclick="closePopup(); generateQuiz(true);"
						>
							Retry with New Words
						</button>
						<button
							type="button"
							class="btn btn-danger"
							onclick="closePopup()"
						>
							Close
						</button>
					</div>
				</div>
			</div>
		</div>

		<!-- Validation Error Modal -->
		<div
			id="validationModal"
			class="modal fade"
			tabindex="-1"
			aria-hidden="true"
		>
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header bg-warning">
						<h5 class="modal-title">Validation Error</h5>
						<button
							type="button"
							class="btn-close"
							data-bs-dismiss="modal"
							aria-label="Close"
						></button>
					</div>
					<div class="modal-body">
						<p id="validationMessage">
							Number of questions must be greater than 0.
						</p>
					</div>
					<div class="modal-footer">
						<button
							type="button"
							class="btn btn-danger"
							data-bs-dismiss="modal"
						>
							Close
						</button>
					</div>
				</div>
			</div>
		</div>

		<!-- Fireworks container -->
		<div class="pyro">
			<div class="before"></div>
			<div class="after"></div>
		</div>

		<script>
			const quizContainer = document.getElementById('quiz');
			const submitBtn = document.getElementById('submitBtn');
			let vocab = [];

			async function loadVocab() {
				const response = await fetch('vocab.json');
				vocab = await response.json();
			}

			function getRandomItems(arr, num) {
				const shuffled = arr.sort(() => 0.5 - Math.random());
				return shuffled.slice(0, num);
			}

			function generateQuiz(newWords = false) {
				quizContainer.innerHTML = '';
				const questionCount = parseInt(
					document.getElementById('questionCount').value,
					10
				);

				// Add validation for question count
				// Add validation for question count
				if (questionCount <= 0) {
					document.getElementById('validationMessage').textContent =
						'Number of questions must be greater than 0';
					const validationModal = new bootstrap.Modal(
						document.getElementById('validationModal')
					);
					validationModal.show();
					return;
				}

				const questions = getRandomItems(vocab, questionCount);

				questions.forEach((item, index) => {
					const options = getRandomItems(vocab, 4);
					if (!options.some((v) => v.meaning === item.meaning)) {
						options[Math.floor(Math.random() * 4)] = item;
					}

					const questionDiv = document.createElement('div');
					questionDiv.className = 'question mb-3';
					questionDiv.innerHTML = `
          <p><strong>${index + 1}. What is the meaning of "${
						item.word
					}"?</strong></p>
          <div class="row g-3">
            ${options
				.map(
					(option, optIndex) => `
              <div class="col-md-6">
                <div class="card option-card" onclick="selectOption(${index}, '${
						option.meaning
					}', this)">
                  <div class="card-body">
                    <div class="card-title">${String.fromCharCode(
						65 + optIndex
					)}. <strong>${option.meaning}</strong></div>
                    <p>Family words: ${option.family.join(', ') || 'None'}</p>
                  </div>
                </div>
              </div>
            `
				)
				.join('')}
          </div>
          <input type="hidden" name="q${index}" id="q${index}" value="">
        `;
					quizContainer.appendChild(questionDiv);
				});

				submitBtn.style.display = 'block';
			}

			function selectOption(questionIndex, option, element) {
				document.getElementById(`q${questionIndex}`).value = option;
				document
					.querySelectorAll(
						`.question:nth-child(${questionIndex + 1}) .option-card`
					)
					.forEach((card) => {
						card.classList.remove('selected');
					});
				element.classList.add('selected');
			}

			function submitQuiz() {
				const questions = document.querySelectorAll('.question');
				let score = 0;
				const incorrectAnswers = [];
				const unansweredQuestions = [];

				// Hide submit button after submission
				submitBtn.style.display = 'none';

				questions.forEach((question, index) => {
					const selectedOption = document.getElementById(
						`q${index}`
					).value;

					const word = vocab.find(
						(v) =>
							v.word ===
							question
								.querySelector('p')
								.textContent.match(/"(.*?)"/)[1]
					);

					if (!selectedOption) {
						unansweredQuestions.push(word);
						return;
					}

					if (selectedOption === word.meaning) {
						score++;
					} else {
						incorrectAnswers.push(word);
					}
				});

				showResult(
					score,
					questions.length,
					incorrectAnswers,
					unansweredQuestions
				);
			}

			function showResult(
				score,
				total,
				incorrectAnswers,
				unansweredQuestions
			) {
				document.getElementById(
					'score'
				).textContent = `You scored ${score} out of ${total}`;

				const incorrectList = document.getElementById('incorrectList');
				incorrectList.innerHTML = '';

				const congratsMessage =
					document.getElementById('congratsMessage');
				congratsMessage.innerHTML = '';

				// Check for perfect score
				if (score === total && unansweredQuestions.length === 0) {
					// Show simple congratulations message
					congratsMessage.innerHTML =
						'<div class="congratulations">Congratulations! Perfect Score! 🎉</div>';

					// Show enhanced fireworks above the modal
					const pyro = document.querySelector('.pyro');
					pyro.style.display = 'block';

					// Add more fireworks after a delay for a staggered effect
					setTimeout(() => {
						const moreFireworks = document.createElement('div');
						moreFireworks.className = 'pyro';
						moreFireworks.style.display = 'block';
						moreFireworks.style.opacity = '0.9';
						moreFireworks.innerHTML =
							'<div class="before"></div><div class="after"></div>';
						document.body.appendChild(moreFireworks);

						// Remove the extra fireworks after 5 seconds
						setTimeout(() => {
							moreFireworks.remove();
						}, 5000);
					}, 1000);

					// Hide fireworks after 6 seconds
					setTimeout(() => {
						pyro.style.display = 'none';
						document
							.querySelectorAll('.pyro')
							.forEach((el) => (el.style.display = 'none'));
					}, 6000);
				}

				if (incorrectAnswers.length > 0) {
					incorrectList.innerHTML +=
						'<h6 class="text-danger">Incorrect Answers:</h6>';
					incorrectAnswers.forEach((item) => {
						const itemDiv = document.createElement('div');
						itemDiv.innerHTML = `
            <p><strong>${item.word}</strong> (${item.wordClass})</p>
            <p>Meaning: ${item.meaning}</p>
            <p>Meaning VN: ${item.meaning_VN}</p>
            <p>Family: ${item.family.join(', ') || 'None'}</p>
            <hr>
          `;
						incorrectList.appendChild(itemDiv);
					});
				}

				if (unansweredQuestions.length > 0) {
					incorrectList.innerHTML +=
						'<h6 class="text-warning">Unanswered Questions:</h6>';
					unansweredQuestions.forEach((item) => {
						const itemDiv = document.createElement('div');
						itemDiv.innerHTML = `
            <p><strong>${item.word}</strong> (${item.wordClass})</p>
            <p>Meaning: ${item.meaning}</p>
            <p>Meaning VN: ${item.meaning_VN}</p>
            <p>Family: ${item.family.join(', ') || 'None'}</p>
            <hr>
          `;
						incorrectList.appendChild(itemDiv);
					});
				}

				const modal = new bootstrap.Modal(
					document.getElementById('resultPopup')
				);
				modal.show();
			}

			function closePopup() {
				const modal = bootstrap.Modal.getInstance(
					document.getElementById('resultPopup')
				);
				modal.hide();

				// Hide all fireworks when popup is closed
				document
					.querySelectorAll('.pyro')
					.forEach((el) => (el.style.display = 'none'));

				// Reset quiz container
				quizContainer.innerHTML = '';
				submitBtn.style.display = 'none';
			}

			loadVocab();
		</script>
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
	</body>
</html>
